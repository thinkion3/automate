name: Android Appium Instagram Bot

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # Runs daily at 2 AM UTC

jobs:
  run-android-bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Java 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'

      - name: Install AVD & Android SDK
        run: |
          sudo apt-get update -y
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils python3-pip unzip curl wget openjdk-11-jdk

          mkdir -p $HOME/android-sdk
          cd $HOME/android-sdk
          wget https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip -O cmdtools.zip
          unzip cmdtools.zip -d cmdline-tools
          mv cmdline-tools cmdline-tools/latest

          echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
          echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$HOME/android-sdk/emulator" >> $GITHUB_PATH
          echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH

          yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=$HOME/android-sdk "platform-tools" "platforms;android-30" "emulator" "system-images;android-30;google_apis;x86_64"

          echo "no" | avdmanager create avd -n test -k "system-images;android-30;google_apis;x86_64" --force

      - name: Start Android Emulator
        run: |
          nohup $HOME/android-sdk/emulator/emulator -avd test -no-window -noaudio -gpu swiftshader_indirect -no-boot-anim &
          adb wait-for-device
          adb shell input keyevent 82 &
          sleep 60  # Wait for full boot

      - name: Install Instagram APK
        run: |
          wget "https://github.com/Alex313031/ig-apk/releases/download/latest/Instagram_v320.0.0.12.116.apk" -O instagram.apk
          adb install instagram.apk

      - name: Install Appium and Python dependencies
        run: |
          pip3 install Appium-Python-Client
          npm install -g appium
          nohup appium &
          sleep 20

      - name: Run Instagram login bot
        env:
          IG_USERNAME: ${{ secrets.IG_USERNAME }}
          IG_PASSWORD: ${{ secrets.IG_PASSWORD }}
        run: |
          python3 appium_bot.py
