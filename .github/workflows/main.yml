name: Android Appium Instagram Bot

on:
  workflow_dispatch:

jobs:
  run-android-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "11"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install system dependencies
        run: |
          # Update package lists
          sudo apt-get update -y
          
          # Install basic dependencies
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils
          sudo apt-get install -y python3-pip unzip curl wget openjdk-11-jdk
          
          # Enable 32-bit architecture for Android emulator
          sudo dpkg --add-architecture i386
          sudo apt-get update -y
          
          # Install common 32-bit libraries (excluding libgl1-mesa-glx:i386 here)
          sudo apt-get install -y \
            libc6:i386 \
            libstdc++6:i386 \
            lib32z1 \
            libbz2-1.0:i386 \
            libx11-6:i386 \
            libxext6:i386 \
            libxrender1:i386 \
            libxtst6:i386 \
            libxi6:i386 \
            libglu1-mesa:i386 \
            libpulse0:i386
          
          echo "✅ Basic system dependencies installed"

      - name: Install libncurses5:i386 workaround
        run: |
          echo "Attempting to install libncurses5:i386..."
          # First, try to install directly (might work if repo changes or on different Ubuntu versions)
          sudo apt-get install -y libncurses5:i386 || {
            echo "Direct installation of libncurses5:i386 failed. Proceeding with manual download from Ubuntu 22.04 archives."
            # Download libtinfo5:i386 (dependency for libncurses5) from Ubuntu 22.04 security updates
            wget http://security.ubuntu.com/ubuntu/pool/universe/n/ncurses/libtinfo5_6.3-2ubuntu0.1_i386.deb -O libtinfo5_i386.deb
            # Download libncurses5:i386 from Ubuntu 22.04 security updates
            wget http://security.ubuntu.com/ubuntu/pool/universe/n/ncurses/libncurses5_6.3-2ubuntu0.1_i386.deb -O libncurses5_i386.deb

            # Install the downloaded packages
            sudo dpkg -i libtinfo5_i386.deb libncurses5_i386.deb || {
              echo "dpkg installation failed. Attempting to fix broken dependencies."
              sudo apt-get install -f -y
              # Try dpkg install again after fixing dependencies
              sudo dpkg -i libtinfo5_i386.deb libncurses5_i386.deb
            }
          }
          echo "✅ libncurses5:i386 (or equivalent) installed"

      - name: Install libgl1-mesa-glx:i386 and libdrm:i386 workaround
        run: |
          echo "Attempting to install libgl1-mesa-glx:i386 and libdrm:i386 dependencies from Ubuntu 22.04 archives..."
          # Download required i386 packages from Ubuntu 22.04 (Jammy Jellyfish) security archives
          wget http://security.ubuntu.com/ubuntu/pool/universe/m/mesa/libgl1-mesa-glx_23.0.4-0ubuntu1~22.04.1_i386.deb -O libgl1-mesa-glx_i386.deb
          wget http://security.ubuntu.com/ubuntu/pool/main/m/mesa/libglapi-mesa_23.0.4-0ubuntu1~22.04.1_i386.deb -O libglapi-mesa_i386.deb
          wget http://security.ubuntu.com/ubuntu/pool/main/libd/libdrm/libdrm2_2.4.113-2~ubuntu0.22.04.1_i386.deb -O libdrm2_i386.deb
          wget http://security.ubuntu.com/ubuntu/pool/main/libd/libdrm/libdrm-intel1_2.4.113-2~ubuntu0.22.04.1_i386.deb -O libdrm-intel1_i386.deb
          wget http://security.ubuntu.com/ubuntu/pool/main/libd/libdrm/libdrm-nouveau2_2.4.113-2~ubuntu0.22.04.1_i386.deb -O libdrm-nouveau2_i386.deb
          wget http://security.ubuntu.com/ubuntu/pool/main/libd/libdrm/libdrm-radeon1_2.4.113-2~ubuntu0.22.04.1_i386.deb -O libdrm-radeon1_i386.deb

          # Install the downloaded packages
          sudo dpkg -i \
            libgl1-mesa-glx_i386.deb \
            libglapi-mesa_i386.deb \
            libdrm2_i386.deb \
            libdrm-intel1_i386.deb \
            libdrm-nouveau2_i386.deb \
            libdrm-radeon1_i386.deb || {
            echo "dpkg installation of libgl/libdrm packages failed. Attempting to fix broken dependencies."
            sudo apt-get install -f -y
            # Try dpkg install again after fixing dependencies
            sudo dpkg -i \
              libgl1-mesa-glx_i386.deb \
              libglapi-mesa_i386.deb \
              libdrm2_i386.deb \
              libdrm-intel1_i386.deb \
              libdrm-nouveau2_i386.deb \
              libdrm-radeon1_i386.deb
          }
          echo "✅ libgl1-mesa-glx:i386 and libdrm:i386 dependencies installed"

      - name: Setup Android SDK
        run: |
          mkdir -p $HOME/android-sdk/cmdline-tools
          cd $HOME/android-sdk/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip -O cmdtools.zip
          unzip -q cmdtools.zip
          mv cmdline-tools latest
          
          # Set environment variables
          echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
          echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$HOME/android-sdk/emulator" >> $GITHUB_PATH
          echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH

      - name: Install Android SDK components
        run: |
          export ANDROID_SDK_ROOT=$HOME/android-sdk
          export ANDROID_HOME=$HOME/android-sdk
          
          # Accept licenses first
          yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses
          
          # Update SDK manager
          $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --update
          
          # Install SDK components with fallback to different API levels
          $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "emulator" \
            "build-tools;30.0.3"
          
          # Try multiple API levels for better compatibility
          $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager \
            "platforms;android-30" \
            "system-images;android-30;google_apis;x86_64" || \
          $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager \
            "platforms;android-29" \
            "system-images;android-29;google_apis;x86_64" || \
          $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager \
            "platforms;android-28" \
            "system-images;android-28;google_apis;x86_64"
          
          echo "✅ Android SDK components installed"

      - name: Create AVD
        run: |
          export ANDROID_SDK_ROOT=$HOME/android-sdk
          export ANDROID_HOME=$HOME/android-sdk
          
          # Determine which system image is available
          if $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --list | grep -q "system-images;android-30;google_apis;x86_64"; then
            SYSTEM_IMAGE="system-images;android-30;google_apis;x86_64"
            API_LEVEL="30"
          elif $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --list | grep -q "system-images;android-29;google_apis;x86_64"; then
            SYSTEM_IMAGE="system-images;android-29;google_apis;x86_64"
            API_LEVEL="29"
          else
            SYSTEM_IMAGE="system-images;android-28;google_apis;x86_64"
            API_LEVEL="28"
          fi
          
          echo "Using system image: $SYSTEM_IMAGE"
          
          # Create AVD with detected system image
          echo "no" | $HOME/android-sdk/cmdline-tools/latest/bin/avdmanager create avd \
            -n test_avd \
            -k "$SYSTEM_IMAGE" \
            --force \
            -c 2048M
          
          # Save API level for later use
          echo "ANDROID_API_LEVEL=$API_LEVEL" >> $GITHUB_ENV
          
          echo "✅ AVD created with API level $API_LEVEL"

      - name: Start Android Emulator
        run: |
          export ANDROID_SDK_ROOT=$HOME/android-sdk
          export ANDROID_HOME=$HOME/android-sdk
          
          # Check available AVDs
          echo "=== Available AVDs ==="
          $HOME/android-sdk/cmdline-tools/latest/bin/avdmanager list avd
          
          # Start emulator with software rendering (more reliable on CI)
          echo "🚀 Starting Android emulator..."
          nohup $HOME/android-sdk/emulator/emulator @test_avd \
            -no-window \
            -no-audio \
            -gpu swiftshader_indirect \
            -no-boot-anim \
            -memory 2048 \
            -cores 2 \
            -netdelay none \
            -netspeed full \
            -no-snapshot \
            -wipe-data \
            -verbose \
            > emulator.log 2>&1 &
          
          echo "⏳ Waiting for emulator to start..."
          # Wait for device with better error handling and longer timeout
          for i in {1..120}; do
            if $HOME/android-sdk/platform-tools/adb devices | grep -q "emulator.*device"; then
              echo "📱 Emulator detected as device"
              break
            elif $HOME/android-sdk/platform-tools/adb devices | grep -q "emulator"; then
              echo "📱 Emulator detected but not ready yet..."
            fi
            echo "Waiting... ($i/120)"
            sleep 3
          done
          
          # Verify device is connected
          echo "=== ADB Devices ==="
          $HOME/android-sdk/platform-tools/adb devices -l
          
          # Wait for boot complete with longer timeout
          echo "⏳ Waiting for boot to complete..."
          for i in {1..120}; do
            boot_completed=$($HOME/android-sdk/platform-tools/adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r\n' || echo "0")
            if [ "$boot_completed" = "1" ]; then
              echo "✅ Boot completed successfully"
              break
            fi
            echo "Boot status: '$boot_completed' ($i/120)"
            sleep 3
          done
          
          # Check if boot actually completed
          final_boot_status=$($HOME/android-sdk/platform-tools/adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r\n' || echo "0")
          if [ "$final_boot_status" != "1" ]; then
            echo "❌ Boot did not complete properly"
            echo "=== Emulator Log Tail ==="
            tail -50 emulator.log || echo "No emulator log found"
            exit 1
          fi
          
          # Basic device setup
          echo "🔧 Setting up device..."
          $HOME/android-sdk/platform-tools/adb shell input keyevent 82 || echo "Could not unlock screen"
          $HOME/android-sdk/platform-tools/adb shell wm density 160 || echo "Could not set density"
          
          # Disable animations for faster automation
          $HOME/android-sdk/platform-tools/adb shell settings put global window_animation_scale 0 || true
          $HOME/android-sdk/platform-tools/adb shell settings put global transition_animation_scale 0 || true
          $HOME/android-sdk/platform-tools/adb shell settings put global animator_duration_scale 0 || true
          
          echo "✅ Emulator setup complete"
          $HOME/android-sdk/platform-tools/adb shell getprop ro.build.version.release

      - name: Install Instagram APK
        run: |
          # Download Instagram APK
          wget -q "https://github.com/Alex313031/ig-apk/releases/download/latest/Instagram_v320.0.0.12.116.apk" -O instagram.apk
          
          # Install APK
          $HOME/android-sdk/platform-tools/adb install -r instagram.apk
          
          # Verify installation
          $HOME/android-sdk/platform-tools/adb shell pm list packages | grep instagram
          echo "✅ Instagram APK installed"

      - name: Install Appium and dependencies
        run: |
          # Install Python dependencies
          pip3 install --upgrade pip
          pip3 install Appium-Python-Client==3.1.0 selenium==4.15.2
          
          # Install Appium 2.x
          npm install -g appium@2.2.1
          
          # Install UiAutomator2 driver
          appium driver install uiautomator2
          
          # Verify installations
          appium --version
          appium driver list
          
          echo "✅ Appium and dependencies installed successfully"

      - name: Start Appium Server
        run: |
          # Start Appium server in background with proper logging
          nohup appium server \
            --port 4723 \
            --allow-insecure chromedriver_autodownload \
            --relaxed-security \
            --log-timestamp \
            --log-no-colors \
            > appium.log 2>&1 &
          
          # Wait for Appium server to start with better error handling
          echo "⏳ Starting Appium server..."
          for i in {1..24}; do
            if curl -s http://localhost:4723/status > /dev/null 2>&1; then
              echo "✅ Appium server is ready"
              break
            fi
            echo "Waiting for Appium server... ($i/24)"
            sleep 5
          done
          
          # Verify server is running
          if ! curl -s http://localhost:4723/status > /dev/null 2>&1; then
            echo "❌ Appium server failed to start"
            echo "=== Appium Log ==="
            cat appium.log || echo "No appium log found"
            exit 1
          fi
          
          echo "🚀 Appium server status:"
          curl -s http://localhost:4723/status | head -20

      - name: Debug Environment
        run: |
          echo "=== System Information ==="
          uname -a
          cat /proc/version
          
          echo "=== Java Version ==="
          java -version
          
          echo "=== Node Version ==="
          node --version
          npm --version
          
          echo "=== Python Version ==="
          python3 --version
          pip3 --version
          
          echo "=== Android SDK ==="
          ls -la $HOME/android-sdk/ || echo "Android SDK directory not found"
          
          echo "=== Available System Images ==="
          $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --list | grep "system-images;android-30" || echo "No system images found"
          
          echo "=== AVD List ==="
          $HOME/android-sdk/cmdline-tools/latest/bin/avdmanager list avd || echo "No AVDs found"
          
          echo "=== KVM Check ==="
          ls -la /dev/kvm || echo "KVM not available"
          
          echo "=== Process List ==="
          ps aux | grep -E "(emulator|appium)" || echo "No emulator/appium processes found"

      - name: Run Instagram Bot
        env:
          IG_USERNAME: ${{ secrets.IG_USERNAME }}
          IG_PASSWORD: ${{ secrets.IG_PASSWORD }}
        run: |
          echo "🤖 Starting Instagram bot..."
          python3 appium_bot.py

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs
          path: |
            emulator.log
            appium.log
